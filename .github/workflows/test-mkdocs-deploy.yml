name: Test mkdocs-deploy

on:
  push:

permissions:
  contents: write
  pages: write

jobs:
  test-pull-request-trigger:
    name: Test Pull Request Trigger
    runs-on: ubuntu-latest
    strategy:
      matrix:
        package-manager: [pip, uv, pixi]
    steps:
      - uses: actions/checkout@v5
        with:
          fetch-depth: 0

      - name: Copy test fixture files (pip/uv)
        if: matrix.package-manager != 'pixi'
        run: |
          cp tests/mkdocs-deploy/test-pull-request-pip-uv/pyproject.toml .
          cp tests/mkdocs-deploy/test-pull-request-pip-uv/mkdocs.yml .
          cp -r tests/mkdocs-deploy/test-pull-request-pip-uv/docs .

      - name: Copy test fixture files (pixi)
        if: matrix.package-manager == 'pixi'
        run: |
          cp tests/mkdocs-deploy/test-pull-request-pixi/pyproject.toml .
          cp tests/mkdocs-deploy/test-pull-request-pixi/mkdocs.yml .
          cp -r tests/mkdocs-deploy/test-pull-request-pixi/docs .
          # Generate pixi.lock if not present (for testing)
          if [ ! -f tests/mkdocs-deploy/test-pull-request-pixi/pixi.lock ]; then
            echo "Warning: pixi.lock not found, will be generated by pixi during setup"
          else
            cp tests/mkdocs-deploy/test-pull-request-pixi/pixi.lock .
          fi

      - name: Test MkDocs deploy for PR
        uses: ./actions/mkdocs-deploy
        with:
          trigger: 'pull_request'
          package-manager: ${{ matrix.package-manager }}
          deploy-token: ${{ secrets.GITHUB_TOKEN }}

      - name: Verify deployment command was attempted
        run: |
          echo "Deployment test completed for ${{ matrix.package-manager }}"

  test-main-trigger:
    name: Test Main Branch Trigger
    runs-on: ubuntu-latest
    steps:
      - uses: actions/checkout@v5
        with:
          fetch-depth: 0

      - name: Copy test fixture files
        run: |
          cp tests/mkdocs-deploy/test-main-trigger/pyproject.toml .
          cp tests/mkdocs-deploy/test-main-trigger/mkdocs.yml .
          cp -r tests/mkdocs-deploy/test-main-trigger/docs .

      - name: Test MkDocs deploy for main
        uses: ./actions/mkdocs-deploy
        with:
          trigger: 'main'
          package-manager: 'uv'
          deploy-token: ${{ secrets.GITHUB_TOKEN }}

  test-release-trigger:
    name: Test Release Trigger
    runs-on: ubuntu-latest
    strategy:
      matrix:
        include:
          - package-manager: uv
            release-tag: "v1.0.0"
            mike-alias: "latest"
          - package-manager: pip
            release-tag: "v2.0.0"
            mike-alias: "stable"
          - package-manager: pixi
            release-tag: "v3.0.0"
            mike-alias: "current"
    steps:
      - uses: actions/checkout@v5
        with:
          fetch-depth: 0

      - name: Copy test fixture files (pip/uv)
        if: matrix.package-manager != 'pixi'
        run: |
          cp tests/mkdocs-deploy/test-release-trigger-pip-uv/pyproject.toml .
          cp tests/mkdocs-deploy/test-release-trigger-pip-uv/mkdocs.yml .
          cp -r tests/mkdocs-deploy/test-release-trigger-pip-uv/docs .

      - name: Copy test fixture files (pixi)
        if: matrix.package-manager == 'pixi'
        run: |
          cp tests/mkdocs-deploy/test-release-trigger-pixi/pyproject.toml .
          cp tests/mkdocs-deploy/test-release-trigger-pixi/mkdocs.yml .
          cp -r tests/mkdocs-deploy/test-release-trigger-pixi/docs .
          # Generate pixi.lock if not present (for testing)
          if [ ! -f tests/mkdocs-deploy/test-release-trigger-pixi/pixi.lock ]; then
            echo "Warning: pixi.lock not found, will be generated by pixi during setup"
          else
            cp tests/mkdocs-deploy/test-release-trigger-pixi/pixi.lock .
          fi

      - name: Test MkDocs deploy for release
        uses: ./actions/mkdocs-deploy
        with:
          trigger: 'release'
          package-manager: ${{ matrix.package-manager }}
          release-tag: ${{ matrix.release-tag }}
          mike-alias: ${{ matrix.mike-alias }}
          deploy-token: ${{ secrets.GITHUB_TOKEN }}

  test-custom-configuration:
    name: Test Custom Configuration
    runs-on: ubuntu-latest
    strategy:
      matrix:
        python-version: ["3.11", "3.12"]
        install-groups: ["docs", "docs dev", "docs test"]
    steps:
      - uses: actions/checkout@v5
        with:
          fetch-depth: 0

      - name: Copy test fixture files
        run: |
          cp tests/mkdocs-deploy/test-custom-configuration/pyproject.toml .
          cp tests/mkdocs-deploy/test-custom-configuration/mkdocs.yml .
          cp -r tests/mkdocs-deploy/test-custom-configuration/docs .

      - name: Test with custom configuration
        uses: ./actions/mkdocs-deploy
        with:
          trigger: 'pull_request'
          package-manager: 'uv'
          python-version: ${{ matrix.python-version }}
          install-groups: ${{ matrix.install-groups }}
          deploy-token: ${{ secrets.GITHUB_TOKEN }}

  test-error-scenarios:
    name: Test Error Scenarios
    runs-on: ubuntu-latest
    steps:
      - uses: actions/checkout@v5
        with:
          fetch-depth: 0

      - name: Test without MkDocs configuration
        id: no-mkdocs-test
        continue-on-error: true
        uses: ./actions/mkdocs-deploy
        with:
          trigger: 'pull_request'
          package-manager: 'uv'
          deploy-token: ${{ secrets.GITHUB_TOKEN }}

      - name: Verify deployment fails without mkdocs.yml
        if: steps.no-mkdocs-test.outcome != 'failure'
        run: |
          echo "ERROR: Deployment should fail without mkdocs.yml"
          exit 1

      - name: Copy test fixture files for missing docs dependencies test
        run: |
          cp tests/mkdocs-deploy/test-error-no-docs-deps/pyproject.toml .
          cp tests/mkdocs-deploy/test-error-no-docs-deps/mkdocs.yml .
          cp -r tests/mkdocs-deploy/test-error-no-docs-deps/docs .

      - name: Test with missing docs dependencies
        id: no-deps-test
        continue-on-error: true
        uses: ./actions/mkdocs-deploy
        with:
          trigger: 'main'
          package-manager: 'uv'
          install-groups: 'dev'  # Wrong group, no mkdocs
          deploy-token: ${{ secrets.GITHUB_TOKEN }}

      - name: Verify deployment fails without mkdocs installed
        if: steps.no-deps-test.outcome != 'failure'
        run: |
          echo "ERROR: Deployment should fail without mkdocs dependencies"
          exit 1

      - name: Test invalid trigger
        id: invalid-trigger-test
        continue-on-error: true
        uses: ./actions/mkdocs-deploy
        with:
          trigger: 'invalid'
          package-manager: 'uv'
          deploy-token: ${{ secrets.GITHUB_TOKEN }}

      - name: Verify invalid trigger handling
        run: |
          echo "Invalid trigger test completed"

  test-git-configuration:
    name: Test Git Configuration
    runs-on: ubuntu-latest
    steps:
      - uses: actions/checkout@v5
        with:
          fetch-depth: 0

      - name: Copy test fixture files
        run: |
          cp tests/mkdocs-deploy/test-git-configuration/pyproject.toml .
          cp tests/mkdocs-deploy/test-git-configuration/mkdocs.yml .
          cp -r tests/mkdocs-deploy/test-git-configuration/docs .

      - name: Clear git config to test action sets it
        run: |
          git config --global --unset user.name || true
          git config --global --unset user.email || true

      - name: Test git configuration
        uses: ./actions/mkdocs-deploy
        with:
          trigger: 'pull_request'
          package-manager: 'pip'
          deploy-token: ${{ secrets.GITHUB_TOKEN }}

      - name: Verify git was configured
        run: |
          git config --global user.name
          git config --global user.email

  test-package-manager-commands:
    name: Test Package Manager Command Execution
    runs-on: ubuntu-latest
    steps:
      - uses: actions/checkout@v5
        with:
          fetch-depth: 0

      - name: Copy test fixture files
        run: |
          cp tests/mkdocs-deploy/test-package-manager-commands/pyproject.toml .
          cp tests/mkdocs-deploy/test-package-manager-commands/mkdocs.yml .
          cp -r tests/mkdocs-deploy/test-package-manager-commands/docs .
          # Copy pixi.lock if it exists
          if [ -f tests/mkdocs-deploy/test-package-manager-commands/pixi.lock ]; then
            cp tests/mkdocs-deploy/test-package-manager-commands/pixi.lock .
          fi

      - name: Test pip command execution
        uses: ./actions/mkdocs-deploy
        with:
          trigger: 'pull_request'
          package-manager: 'pip'
          deploy-token: ${{ secrets.GITHUB_TOKEN }}

      - name: Test uv command execution
        uses: ./actions/mkdocs-deploy
        with:
          trigger: 'main'
          package-manager: 'uv'
          deploy-token: ${{ secrets.GITHUB_TOKEN }}

      - name: Test pixi command execution
        uses: ./actions/mkdocs-deploy
        with:
          trigger: 'release'
          package-manager: 'pixi'
          release-tag: 'v1.0.0'
          deploy-token: ${{ secrets.GITHUB_TOKEN }}

  test-release-tag-resolution:
    name: Test Release Tag Resolution
    runs-on: ubuntu-latest
    steps:
      - uses: actions/checkout@v5
        with:
          fetch-depth: 0

      - name: Copy test fixture files
        run: |
          cp tests/mkdocs-deploy/test-release-tag-resolution/pyproject.toml .
          cp tests/mkdocs-deploy/test-release-tag-resolution/mkdocs.yml .
          cp -r tests/mkdocs-deploy/test-release-tag-resolution/docs .

      - name: Test with explicit release tag
        uses: ./actions/mkdocs-deploy
        with:
          trigger: 'release'
          package-manager: 'uv'
          release-tag: 'v4.5.6'
          deploy-token: ${{ secrets.GITHUB_TOKEN }}

      - name: Test without explicit release tag (simulated)
        env:
          GITHUB_EVENT_NAME: release
        uses: ./actions/mkdocs-deploy
        with:
          trigger: 'release'
          package-manager: 'uv'
          deploy-token: ${{ secrets.GITHUB_TOKEN }}