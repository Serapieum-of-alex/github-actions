name: Test python-setup/pixi

on:
  push:

jobs:

  test-pixi-lock-verification-validation:
    name: Test pixi action - Lock verification validation (should fail without lock file)
    runs-on: ubuntu-latest
    steps:
      - uses: actions/checkout@v5

      - name: Create test pyproject.toml
        run: |
          cat > pyproject.toml << 'EOF'
          [project]
          name = "lock-verification-validation-test"
          version = "0.1.0"
          dependencies = []

          [tool.pixi.workspace]
          channels = ["conda-forge"]
          platforms = ["linux-64", "osx-64", "osx-arm64", "win-64"]

          [tool.pixi.dependencies]
          python = ">=3.11"
          numpy = ">=1.26"
          EOF

      - name: Test verify-lock without lock file (should fail)
        id: verify-lock-without-lock
        continue-on-error: true
        uses: ./actions/python-setup/pixi
        with:
          verify-lock: "true"
          cache: "false"

      - name: Verify validation failed
        if: steps.verify-lock-without-lock.outcome != 'failure'
        run: |
          echo "ERROR: Lock verification validation should have failed without lock file"
          exit 1

      - name: Verify error message is helpful
        if: steps.verify-lock-without-lock.outcome == 'failure'
        run: |
          echo "✓ Validation correctly failed when verify-lock was enabled without lock file"


  test-pixi-caching-validation:
    name: Test pixi action - Cache validation (should fail without lock file)
    runs-on: ubuntu-latest
    steps:
      - uses: actions/checkout@v5

      - name: Create test pyproject.toml
        run: |
          cat > pyproject.toml << 'EOF'
          [project]
          name = "cache-validation-test"
          version = "0.1.0"
          dependencies = []

          [tool.pixi.workspace]
          channels = ["conda-forge"]
          platforms = ["linux-64", "osx-64", "osx-arm64", "win-64"]

          [tool.pixi.dependencies]
          python = ">=3.11"
          numpy = ">=1.26"
          EOF

      - name: Test cache without lock file (should fail)
        id: cache-without-lock
        continue-on-error: true
        uses: ./actions/python-setup/pixi
        with:
          cache: "true"

      - name: Verify validation failed
        if: steps.cache-without-lock.outcome != 'failure'
        run: |
          echo "ERROR: Cache validation should have failed without lock file"
          exit 1

      - name: Verify error message is helpful
        if: steps.cache-without-lock.outcome == 'failure'
        run: |
          echo "✓ Validation correctly failed when cache was enabled without lock file"


  test-pixi-error-scenarios:
    name: Test pixi action - Error scenarios
    runs-on: ubuntu-latest
    steps:
      - uses: actions/checkout@v5

      - name: Test without pyproject.toml
        id: no-toml-test
        continue-on-error: true
        uses: ./actions/python-setup/pixi

      - name: Verify action failed without pyproject.toml
        if: steps.no-toml-test.outcome != 'failure'
        run: |
          echo "ERROR: Action should fail without pyproject.toml"
          exit 1
