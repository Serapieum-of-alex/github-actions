name: 'GitHub Release'
description: 'Create a GitHub release with optional package manager setup for building/testing'

inputs:
  github-token:
    description: |
      GitHub token for creating releases. Typically use the built-in GITHUB_TOKEN or a personal access token.
      Example: secrets.GITHUB_TOKEN
    required: true
  release-branch:
    description: |
      Branch to create release from. The branch that contains the code to be released.
      Examples: 'main', 'develop', 'release/v2.0', 'production'
    required: false
    default: 'main'
  increment:
    description: |
      Version increment type used by commitizen for semantic versioning.
      - patch: Bug fixes (1.0.0 -> 1.0.1)
      - minor: New features (1.0.1 -> 1.1.0)
      - major: Breaking changes (1.1.0 -> 2.0.0)
    required: false
    type: choice
    options:
      - patch
      - minor
      - major
    default: 'patch'
  prerelease-type:
    description: |
      Prerelease type appended to the version (used with commitizen --prerelease flag).
      - none: Standard release (1.0.0)
      - alpha: Alpha release (1.0.0-alpha.1)
      - beta: Beta release (1.0.0-beta.1)
      - rc: Release candidate (1.0.0-rc.1)
    required: false
    type: choice
    options:
      - none
      - alpha
      - beta
      - rc
    default: 'none'
  draft:
    description: |
      Create as draft release (passed to softprops/action-gh-release).
      - 'true': Release will be created as draft (not published)
      - 'false': Release will be published immediately
    required: false
    default: 'false'
  package-manager:
    description: |
      Package manager to use for setting up Python environment before release.
      Determines which python-setup action to use.
      - pip: Standard pip with pyproject.toml
      - uv: UV package manager (faster, modern)
      - pixi: Pixi package manager (conda-based)
    required: false
    type: choice
    options:
      - pip
      - uv
      - pixi
    default: 'uv'
  python-version:
    description: |
      Python version to install (passed to actions/setup-python).
      Supports semantic versioning and version ranges.
      Examples: '3.12', '3.11', '3.10', '3.9', '3.12.0', '3.x'
    required: false
    default: '3.12'
  install-groups:
    description: |
      Dependency groups or environments to install.
      Format varies by package-manager:

      For pip/uv (passed to install-groups):
        - "groups: dev test" - Install dependency groups (PEP 735)
        - "extras: aws viz" - Install optional dependencies (extras)
        - "groups: dev docs, extras: aws" - Combine both
        - "" - Install only core dependencies

      For pixi (passed to environments and activate-environment):
        - "default" - Use default environment
        - "py311" - Single named environment
        - "py312 py313" - Multiple environments (space-separated)

      Note: When using pixi, specify only one environment name as it's used for both
      environments and activate-environment parameters.
    required: false
    default: 'groups: docs dev'

runs:
  using: 'composite'
  steps:
    - name: Checkout repository
      uses: actions/checkout@v5
      with:
        fetch-depth: 0
        ref: ${{ inputs.release-branch }}

    - name: Set up Python environment (pip)
      if: ${{ inputs.package-manager == 'pip' }}
      uses: Serapieum-of-alex/github-actions/actions/python-setup/pip@pip/v1
      with:
        python-version: ${{ inputs.python-version }}
        install-groups: ${{ inputs.install-groups }}

    - name: Set up Python environment (uv)
      if: ${{ inputs.package-manager == 'uv' }}
      uses: Serapieum-of-alex/github-actions/actions/python-setup/uv@uv/v1
      with:
        python-version: ${{ inputs.python-version }}
        install-groups: ${{ inputs.install-groups }}

    - name: Set up Python environment (pixi)
      if: ${{ inputs.package-manager == 'pixi' }}
      uses: Serapieum-of-alex/github-actions/actions/python-setup/pixi@pixi/v1
      with:
        environments: ${{ inputs.install-groups }}
        activate-environment: ${{ inputs.install-groups }}

    - name: Configure Git
      shell: bash
      run: |
        echo "::group::Configuring Git"
        git config --global user.name '${{ github.actor }}'
        git config --global user.email '${{ github.actor }}@users.noreply.github.com'
        echo "::endgroup::"

    - name: Generate changelog and bump version with commitizen
      id: bump_version
      shell: bash
      run: |
        echo "::group::Generating changelog and bumping version"
        
        # Build commitizen command
        if [ "${{ inputs.package-manager }}" = "pip" ]; then
          CZ_CMD="cz"
        elif [ "${{ inputs.package-manager }}" = "pixi" ]; then
          CZ_CMD="pixi run -e ${{ inputs.install-groups }} cz"
        else
          CZ_CMD="${{ inputs.package-manager }} run cz"
        fi
        
        # Get current version first
        CURRENT_VERSION=$($CZ_CMD version --project)
        echo "Current version: $CURRENT_VERSION"
        
        # Calculate what the next version will be (dry run)
        echo "Calculating next version..."
        if [ "${{ inputs.prerelease-type }}" != "none" ]; then
          NEXT_VERSION=$($CZ_CMD bump --dry-run --increment ${{ inputs.increment }} --prerelease ${{ inputs.prerelease-type }} | grep "tag to create" | awk '{print $NF}')
        else
          NEXT_VERSION=$($CZ_CMD bump --dry-run --increment ${{ inputs.increment }} | grep "tag to create" | awk '{print $NF}')
        fi
        
        echo "Next version will be: $NEXT_VERSION"
        
        # Generate changelog with the calculated version
        echo "Generating changelog..."
        $CZ_CMD changelog --unreleased-version="$NEXT_VERSION" --incremental
        
        # Actually bump version
        echo "Bumping version..."
        if [ "${{ inputs.prerelease-type }}" != "none" ]; then
          $CZ_CMD bump --yes --increment ${{ inputs.increment }} --prerelease ${{ inputs.prerelease-type }}
        else
          $CZ_CMD bump --yes --increment ${{ inputs.increment }}
        fi
        
        # Verify the new version
        NEW_VERSION=$($CZ_CMD version --project)
        echo "NEW_VERSION=$NEW_VERSION" >> $GITHUB_OUTPUT
        echo "Final version: $NEW_VERSION"
        
        echo "::endgroup::"

    - name: Push changes and tags
      shell: bash
      run: |
        echo "::group::Pushing changes and tags"
        
        echo "Pushing changes to repository"
        if ! git push; then
          echo "::error::Failed to push changes to repository"
          exit 1
        fi
        
        echo "Pushing tags to repository"
        if ! git push --tags; then
          echo "::error::Failed to push tags to repository"
          exit 1
        fi
        
        echo "::endgroup::"

    - name: Create GitHub Release
      uses: softprops/action-gh-release@v2
      with:
        token: ${{ inputs.github-token }}
        name: ${{ steps.bump_version.outputs.NEW_VERSION }}
        tag_name: ${{ steps.bump_version.outputs.NEW_VERSION }}
        draft: ${{ inputs.draft == 'true' }}
        prerelease: ${{ contains(steps.bump_version.outputs.NEW_VERSION, '-') || contains(steps.bump_version.outputs.NEW_VERSION, 'alpha') || contains(steps.bump_version.outputs.NEW_VERSION, 'beta') || contains(steps.bump_version.outputs.NEW_VERSION, 'rc') }}
        generate_release_notes: true